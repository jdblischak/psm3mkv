<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="psm3mkv">
<title>Example use of psm3mkv • psm3mkv</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Example use of psm3mkv">
<meta property="og:description" content="psm3mkv">
<meta property="og:image" content="https://merck.github.io/psm3mkv/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">psm3mkv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example.html">Example use of psm3mkv</a>
    <a class="dropdown-item" href="../articles/mortality-adjustments.html">Mortality adjustments</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Merck/psm3mkv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Example use of psm3mkv</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/psm3mkv/blob/HEAD/vignettes/example.Rmd" class="external-link"><code>vignettes/example.Rmd</code></a></small>
      <div class="d-none name"><code>example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette walks through evaluating the partitioned survival model
(PSM) and state transition model structures (either clock reset, STM-CR,
or clock forward types, STM-CF) to a dataset derived from the
<em>bosms3</em> dataset that comes with the
[flexsurv::flexsurv-package()].[1] A review of PSMs and STMs in oncology
cost-effectiveness models is provided by Woods et al.[2]</p>
<p>First we need to install and load the packages of interest (with
thanks to <span class="citation">@vbaliga</span> for <a href="https://vbaliga.github.io/posts/2019-04-28-verify-that-r-packages-are-installed-and-loaded/" class="external-link">this
helpful code</a>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install the latest release of psm3mkv from github</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://devtools.r-lib.org/" class="external-link">"devtools"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://pak.r-lib.org/" class="external-link">"pak"</a></span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"Merck/psm3mkv"</span>,</span>
<span>                        ref<span class="op">=</span><span class="st">"main"</span>,</span>
<span>                        build_vignettes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; lme4 (1.1-35.2 -&gt; 1.1-35.3) [CRAN]</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="color: #00BBBB;">R CMD build</span> <span style="color: #00BBBB;">─────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; * checking for file ‘/tmp/RtmpM8OgTl/remotes1d9f340b6365/Merck-psm3mkv-0f96d8e/DESCRIPTION’ ... OK</span></span>
<span><span class="co">#&gt; * preparing ‘psm3mkv’:</span></span>
<span><span class="co">#&gt; * checking DESCRIPTION meta-information ... OK</span></span>
<span><span class="co">#&gt; * checking for LF line-endings in source and make files and shell scripts</span></span>
<span><span class="co">#&gt; * checking for empty or unneeded directories</span></span>
<span><span class="co">#&gt; * building ‘psm3mkv_0.2.1.tar.gz’</span></span>
<span></span>
<span><span class="co"># First specify the packages of interest</span></span>
<span><span class="va">packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"psm3mkv"</span>, <span class="st">"dplyr"</span>, <span class="st">"boot"</span>, <span class="st">"ggsci"</span>, <span class="st">"flexsurv"</span>, <span class="st">"survival"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now load or install &amp; load all</span></span>
<span><span class="va">package.check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">packages</span>,</span>
<span>  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">x</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">x</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">x</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="obtaining-a-suitable-dataset">Obtaining a suitable dataset<a class="anchor" aria-label="anchor" href="#obtaining-a-suitable-dataset"></a>
</h2>
<p>First we create a suitable patient-level dataset using
<em>create_dummydata()</em>. Here we load data derived from the
<em>bosms3</em> dataset with the <em>flexsurv</em> package.[2]</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create and review the dummy dataset</span></span>
<span><span class="va">bosonc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_dummydata.html">create_dummydata</a></span><span class="op">(</span><span class="st">"flexbosms"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;    ptid pfs.durn pfs.flag os.durn os.flag ttp.durn ttp.flag</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1   18.7          1   42.9        1   18.7          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2   12.0          1   23.3        1   12.0          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3    0.452        1    8.81       1    0.452        1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4    9.07         1   52.7        1    9.07         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5   47.7          0   47.7        0   47.7          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6    3.26         1   13.1        1    3.26         1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span><span class="co">#&gt;       ptid           pfs.durn          pfs.flag         os.durn      </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   : 0.1071   Min.   :0.0000   Min.   : 0.881  </span></span>
<span><span class="co">#&gt;  1st Qu.: 51.75   1st Qu.: 4.2381   1st Qu.:0.0000   1st Qu.: 7.893  </span></span>
<span><span class="co">#&gt;  Median :102.50   Median : 9.7262   Median :1.0000   Median :15.226  </span></span>
<span><span class="co">#&gt;  Mean   :102.50   Mean   :11.5630   Mean   :0.6471   Mean   :17.055  </span></span>
<span><span class="co">#&gt;  3rd Qu.:153.25   3rd Qu.:16.2321   3rd Qu.:1.0000   3rd Qu.:22.729  </span></span>
<span><span class="co">#&gt;  Max.   :204.00   Max.   :48.5357   Max.   :1.0000   Max.   :52.702  </span></span>
<span><span class="co">#&gt;     os.flag          ttp.durn          ttp.flag     </span></span>
<span><span class="co">#&gt;  Min.   :0.0000   Min.   : 0.1071   Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000   1st Qu.: 4.2381   1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :0.0000   Median : 9.7262   Median :1.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.4755   Mean   :11.5630   Mean   :0.5049  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000   3rd Qu.:16.2321   3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000   Max.   :48.5357   Max.   :1.0000</span></span></code></pre></div>
<p>The dataset contains TTP, PFS and OS data for 204 patients.</p>
</div>
<div class="section level2">
<h2 id="fit-survival-curves-to-the-relevant-endpoints">Fit survival curves to the relevant endpoints<a class="anchor" aria-label="anchor" href="#fit-survival-curves-to-the-relevant-endpoints"></a>
</h2>
<p>The three cost-effectiveness model structures we are considering rely
on modeling not only of PFS, TTP and OS, but additionally three other
endpoints:</p>
<ul>
<li>pre-progression death (PPD),</li>
<li>post progression survival as a function of time from baseline (known
as ‘clock forward’, PPS-CF), and</li>
<li>post-progression survival as a function of time from progression
(known as ‘clock reset’, PPS-CR).</li>
</ul>
<p>Once we have a suitable dataset, we will fit statistical models to
these six endpoints.</p>
<div class="section level3">
<h3 id="parametric-distributions">Parametric distributions<a class="anchor" aria-label="anchor" href="#parametric-distributions"></a>
</h3>
<p>Let us start by considering parametric distributions. This uses the
function <em>fit_ends_mods_par()</em>, so called because it cycles
through fitting endpoints and models. The original dataset contained
only three of these endpoints, the other three endpoints are calculated
within the function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a vector of distributions of interest (flexsurv notation)</span></span>
<span><span class="va">alldists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp"</span>, <span class="st">"weibullPH"</span>, <span class="st">"llogis"</span>, <span class="st">"lnorm"</span>, <span class="st">"gamma"</span>, <span class="st">"gompertz"</span>, <span class="st">"gengamma"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit all distributions to all endpoints (except gengamma to PPD and TTP)</span></span>
<span><span class="va">allfits_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_ends_mods_par.html">fit_ends_mods_par</a></span><span class="op">(</span><span class="va">bosonc</span>,</span>
<span>                            cuttime<span class="op">=</span><span class="fl">0</span>,</span>
<span>                            ppd.dist<span class="op">=</span><span class="va">alldists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>                            ttp.dist<span class="op">=</span><span class="va">alldists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>                            pfs.dist<span class="op">=</span><span class="va">alldists</span>,</span>
<span>                            os.dist<span class="op">=</span><span class="va">alldists</span>,</span>
<span>                            pps_cf.dist<span class="op">=</span><span class="va">alldists</span>,</span>
<span>                            pps_cr.dist<span class="op">=</span><span class="va">alldists</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example 1 - PFS endpoint, distribution 2 (weibullPH)</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, dist = ..2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;        est     L95%    U95%    se    </span></span>
<span><span class="co">#&gt; shape  0.9313  0.8080  1.0733  0.0675</span></span>
<span><span class="co">#&gt; scale  0.0676  0.0453  0.1009  0.0138</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -512.0729, df = 2</span></span>
<span><span class="co">#&gt; AIC = 1028.146</span></span>
<span></span>
<span><span class="co"># Example 2 - Parameter values for PPS-CF and PPS-CR endpoints for distribution 3 (llogis)</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">res</span></span>
<span><span class="co">#&gt;             est     L95%     U95%        se</span></span>
<span><span class="co">#&gt; shape  1.625037 1.264658  2.08811 0.2078833</span></span>
<span><span class="co">#&gt; scale 12.184292 8.588947 17.28465 2.1737642</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cr</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">res</span></span>
<span><span class="co">#&gt;             est     L95%      U95%        se</span></span>
<span><span class="co">#&gt; shape  1.602773 1.321696  1.943626 0.1576797</span></span>
<span><span class="co">#&gt; scale 11.031674 8.769443 13.877487 1.2917274</span></span></code></pre></div>
<p>We have fitted multiple parametric distributions to each endpoint. We
only need to retain the best-fitting distribution, which we select using
<em>find_bestfit_par()</em> on the basis of the distribution having the
lowest Akaike Information Criterion (AIC).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pick out best distribution according to min AIC</span></span>
<span><span class="va">fitpar.ppd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">ppd</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.ttp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">ttp</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pfs</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">os</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pps_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pps_cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_par.html">find_bestfit_par</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cr</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the selection for PFS</span></span>
<span><span class="va">fitpar.pfs</span></span>
<span><span class="co">#&gt; $fit</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, dist = ..2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;       est      L95%     U95%     se     </span></span>
<span><span class="co">#&gt; rate  0.05596  0.04718  0.06637  0.00487</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -512.5726, df = 1</span></span>
<span><span class="co">#&gt; AIC = 1027.145</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 11</span></span></span>
<span><span class="co">#&gt;      id dists      npts  pars loglik conv  posdef   aic   bic rankaic rankbic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 exp         204     1  -<span style="color: #BB0000;">513.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>027. <span style="text-decoration: underline;">1</span>030.       1       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 weibullPH   204     2  -<span style="color: #BB0000;">512.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>028. <span style="text-decoration: underline;">1</span>035.       3       3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 llogis      204     2  -<span style="color: #BB0000;">513.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>037.       6       5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 lnorm       204     2  -<span style="color: #BB0000;">517.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>038. <span style="text-decoration: underline;">1</span>044.       7       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 gamma       204     2  -<span style="color: #BB0000;">512.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>028. <span style="text-decoration: underline;">1</span>035.       4       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 gompertz    204     2  -<span style="color: #BB0000;">512.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>027. <span style="text-decoration: underline;">1</span>034.       2       2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>     7 gengamma    204     3  -<span style="color: #BB0000;">512.</span> TRUE  TRUE   <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>040.       5       6</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="royston-parmar-splines-models">Royston-Parmar splines models<a class="anchor" aria-label="anchor" href="#royston-parmar-splines-models"></a>
</h3>
<p>An alternative approach to parametric modeling is the use of
Royston-Parmar splines.[3] We can follow a similar approach, again using
<em>flexsurv</em> [2] to identify the best-fitting spline distributions.
To the six endpoints, we fit 9 spline models: 1, 2 or 3 (internal) knots
with either odds, hazard or normal scales. This uses
<em>fit_ends_mods_spl()</em>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit 1-3 knot splines with all 3 scales (odds, hazard, normal) to each endpoint</span></span>
<span><span class="va">allfits_spl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_ends_mods_spl.html">fit_ends_mods_spl</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example - PFS endpoint - 1 knot, odds scale</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, k = ..2, scale = ..3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;         est       L95%      U95%      se      </span></span>
<span><span class="co">#&gt; gamma0  -2.84806  -3.29863  -2.39748   0.22989</span></span>
<span><span class="co">#&gt; gamma1   0.83234   0.44998   1.21469   0.19508</span></span>
<span><span class="co">#&gt; gamma2  -0.02545  -0.05136   0.00045   0.01322</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -511.7148, df = 3</span></span>
<span><span class="co">#&gt; AIC = 1029.43</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">aux</span><span class="op">$</span><span class="va">scale</span> <span class="co"># Scale</span></span>
<span><span class="co">#&gt; [1] "odds"</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">aux</span><span class="op">$</span><span class="va">knots</span> <span class="co"># Knot locations (log time)</span></span>
<span><span class="co">#&gt;                 50%           </span></span>
<span><span class="co">#&gt; -2.233592  2.008522  3.882300</span></span></code></pre></div>
<p>We have fitted multiple splines to each endpoint. We only need to
retain the best-fitting distribution, which we select on the basis of
the distribution having the lowest Akaike Information Criterion (AIC).
We use <em>find_bestfit_spl()</em> for this.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pick out best distribution according to min AIC</span></span>
<span><span class="va">fitspl.ppd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">ppd</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.ttp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">ttp</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">os</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pps_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cf</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pps_cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit_spl.html">find_bestfit_spl</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cr</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the selection for PFS</span></span>
<span><span class="va">fitspl.pfs</span></span>
<span><span class="co">#&gt; $fit</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, k = ..2, scale = ..3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;         est       L95%      U95%      se      </span></span>
<span><span class="co">#&gt; gamma0  -1.62401  -1.84681  -1.40122   0.11367</span></span>
<span><span class="co">#&gt; gamma1   0.37082   0.20155   0.54008   0.08636</span></span>
<span><span class="co">#&gt; gamma2  -0.02243  -0.03539  -0.00947   0.00661</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -511.4637, df = 3</span></span>
<span><span class="co">#&gt; AIC = 1028.927</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 11</span></span></span>
<span><span class="co">#&gt;      id nknots scales  npts  pars loglik conv    aic   bic rankaic rankbic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1      1 hazard   204     3  -<span style="color: #BB0000;">512.</span> TRUE  <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>040.       5       3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2      1 odds     204     3  -<span style="color: #BB0000;">512.</span> TRUE  <span style="text-decoration: underline;">1</span>029. <span style="text-decoration: underline;">1</span>039.       2       2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3      1 normal   204     3  -<span style="color: #BB0000;">511.</span> TRUE  <span style="text-decoration: underline;">1</span>029. <span style="text-decoration: underline;">1</span>039.       1       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4      2 hazard   204     4  -<span style="color: #BB0000;">512.</span> TRUE  <span style="text-decoration: underline;">1</span>032. <span style="text-decoration: underline;">1</span>045.       9       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5      2 odds     204     4  -<span style="color: #BB0000;">511.</span> TRUE  <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>044.       7       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6      2 normal   204     4  -<span style="color: #BB0000;">511.</span> TRUE  <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>044.       8       5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>     7      3 hazard   204     5  -<span style="color: #BB0000;">510.</span> TRUE  <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>046.       3       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>     8      3 odds     204     5  -<span style="color: #BB0000;">510.</span> TRUE  <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>047.       6       9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span>     9      3 normal   204     5  -<span style="color: #BB0000;">510.</span> TRUE  <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>046.       4       8</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combine-the-best-fits">Combine the best fits<a class="anchor" aria-label="anchor" href="#combine-the-best-fits"></a>
</h3>
<p>Finally, we select our preferred curves for each endpoint. These may
or may not be those selected as the minimum AIC and may be parametric
fits or spline fits. This list is deliberately programmed manually - and
carefully. Our example does not use the best fits in each case but
merely illustrates the options available to the modeler.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bring together our preferred fits for each endpoint in a list</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ppd <span class="op">=</span> <span class="va">fitpar.ppd</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>               ttp <span class="op">=</span> <span class="va">fitpar.ttp</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>               pfs <span class="op">=</span> <span class="va">fitspl.pfs</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>               os <span class="op">=</span> <span class="va">fitspl.os</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>               pps_cf <span class="op">=</span> <span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span>,</span>
<span>               pps_cr <span class="op">=</span> <span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cr</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span>               <span class="op">)</span></span></code></pre></div>
<p>Let us count how many parameters we are using in each model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pull out number of parameters used for each endpoint</span></span>
<span><span class="va">count_npar</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_vec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">~</span><span class="va">params</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">npars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PSM uses PFS (3) and OS (4) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="co"># STM_CF uses PPD (1), TTP (2) and PPS_CF (5) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="co"># STM_CR uses PPD (1), TTP (2) and PPS_CR (6) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-likelihood-values-for-the-three-model-structures">Comparing likelihood values for the three model structures<a class="anchor" aria-label="anchor" href="#comparing-likelihood-values-for-the-three-model-structures"></a>
</h2>
<p>Given the selected survival modeling of each endpoint, we can now
calculate and compare the (log-)likelihood of each of the three model
structures. We can also check this output to ensure that the number of
parameters used in each model structure matches what we derived
earlier.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_likes.html">calc_likes</a></span><span class="op">(</span><span class="va">bosonc</span>, <span class="va">params</span><span class="op">)</span></span>
<span><span class="va">ll_all</span></span>
<span><span class="co">#&gt; $detailed</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   valid outcome  npts   ll_1   ll_2   ll_3   ll_4</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> FALSE       4     1   <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> TRUE        1    72  -<span style="color: #BB0000;">64.8</span>  -<span style="color: #BB0000;">64.8</span>  -<span style="color: #BB0000;">64.7</span>  -<span style="color: #BB0000;">64.7</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> TRUE        2    29 -<span style="color: #BB0000;">152.</span>  -<span style="color: #BB0000;">148.</span>  -<span style="color: #BB0000;">147.</span>  -<span style="color: #BB0000;">147.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> TRUE        3    35 -<span style="color: #BB0000;">151.</span>  -<span style="color: #BB0000;">149.</span>  -<span style="color: #BB0000;">148.</span>  -<span style="color: #BB0000;">148.</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> TRUE        4    67 -<span style="color: #BB0000;">469.</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> TRUE        4    68   <span style="color: #BB0000;">NA</span>   -<span style="color: #BB0000;">471.</span>  -<span style="color: #BB0000;">474.</span>  -<span style="color: #BB0000;">474.</span> </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $valid</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   methno methname    npts_TRUE npts_FALSE ll_TRUE ll_FALSE</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      1 psm_simple        203          1   -<span style="color: #BB0000;">836.</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      2 psm_complex       203          1   -<span style="color: #BB0000;">828.</span>    -<span style="color: #BB0000;">5.11</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      3 stm_cf            203          1   -<span style="color: #BB0000;">828.</span>    -<span style="color: #BB0000;">5.85</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      4 stm_cr            203          1   -<span style="color: #BB0000;">827.</span>    -<span style="color: #BB0000;">6.20</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sumall</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 10</span></span></span>
<span><span class="co">#&gt;   validall methno methname     npts      ll nparam   aic   bic rank_aic rank_bic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> FALSE         1 psm_simple      1   <span style="color: #BB0000;">NA</span>         7   <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> FALSE         2 psm_complex     1   -<span style="color: #BB0000;">5.11</span>      8   <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> FALSE         3 stm_cf          1   -<span style="color: #BB0000;">5.85</span>      6   <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> FALSE         4 stm_cr          1   -<span style="color: #BB0000;">6.20</span>      7   <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> TRUE          1 psm_simple    203 -<span style="color: #BB0000;">836.</span>        7 <span style="text-decoration: underline;">1</span>685. <span style="text-decoration: underline;">1</span>709.        4        4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> TRUE          2 psm_complex   203 -<span style="color: #BB0000;">828.</span>        8 <span style="text-decoration: underline;">1</span>672. <span style="text-decoration: underline;">1</span>698.        3        3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> TRUE          3 stm_cf        203 -<span style="color: #BB0000;">828.</span>        6 <span style="text-decoration: underline;">1</span>667. <span style="text-decoration: underline;">1</span>687.        2        1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> TRUE          4 stm_cr        203 -<span style="color: #BB0000;">827.</span>        7 <span style="text-decoration: underline;">1</span>667. <span style="text-decoration: underline;">1</span>690.        1        2</span></span></code></pre></div>
<p>In this case, the model structures could be fitted to 203 of the 204
patients. Among the 203 patients where models could be fitted, the
STM-CR model has the greatest likelihood (best fitting) and also the
lowest AIC (most efficient). (Since these are not nested models, and
statistical distributions under the null hypothesis are not easily
formed, we cannot readily derive a p-value for the statistical
significance of this difference.)</p>
</div>
<div class="section level2">
<h2 id="other-measures-of-goodness-of-fit">Other measures of goodness of fit<a class="anchor" aria-label="anchor" href="#other-measures-of-goodness-of-fit"></a>
</h2>
<p>The Brier score is a measure of goodness of fit of a survival model
at a particular point in time to a set of patient time-to-event data.
Originally developed for measuring the performance of weather
forecasting, this metric has since been used in other applications. An
extension of the Brier score is the integral of the Brier score, which
is an ‘area under the curve’ measure of concordance of the survival
model to a given set of patient time-to-event data. The integral is
taken between the minimum and maximum event or censoring times in the
dataset. Calculations are provided in the <em>SurvMetrics</em> R
package, which can be slow to run (about 1 minute in this
example).[4]</p>
<p>The <em>psm3mkv</em> package allows examination of Integrated Brier
Scores in the fit of Overall Survival by each of the model
structures.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calc_ibs(bosonc, params)</span></span></code></pre></div>
<p>In this case, the IBS calculation involved integrating between times
1.18 and 52.70. The PSM had the least IBS and best fit (IBS=0.1771); the
two STMs had slightly greater IBS values (0.1773 for CF and 0.1776 for
CR).</p>
</div>
<div class="section level2">
<h2 id="comparing-the-implied-restricted-mean-durations">Comparing the implied (restricted) mean durations<a class="anchor" aria-label="anchor" href="#comparing-the-implied-restricted-mean-durations"></a>
</h2>
<p>In order to understand the degree of structural uncertainty
(sensitivity to the choice of model structure), we calculate the
(restricted) mean durations in progression-free (PF) and progressed
disease (PD) states by model type. To do this, we call the
<em>calc_allrmds()</em> function with the dataset and statistical
distributions we wish to consider for each endpoint. The function also
allows specification of the patient subset to use (<em>inclset</em>,
important for bootstrapping later) and the time horizon. The units for
the time horizon are 52.18 times shorter than the units for the output
because - the time horizon can be considered to be in units of years,
whereas the output is in units of weeks.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call the RMD functions</span></span>
<span><span class="va">rmd_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_allrmds.html">calc_allrmds</a></span><span class="op">(</span><span class="va">bosonc</span>, dpam<span class="op">=</span><span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then review the mean duration in PF, PD and total alive (OS)</span></span>
<span><span class="va">rmd_all</span><span class="op">$</span><span class="va">results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;      pf    pd    os model </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  22.0  5.41  27.4 PSM   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  20.0 10.4   30.4 STM-CF</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  20.0 13.3   33.3 STM-CR</span></span></code></pre></div>
<p>The two STMs estimate a duration in the PF state slightly longer than
the PSM. The PSM also estimates the least time in the PD state and alive
overall than the other models. The STM-CF provides the longest estimate
of time in the PD state and overall.</p>
<p>The above output can be bootstrapped to generate standard errors.
Here we use just 10 boostrap samples (<code>R=10</code>) just to
illustrate the process. In practice, we would want to use far more than
10 samples.</p>
<p>Note that the percentiles information reported indicates that in a
small number of samples, the restricted mean duration in PD was
restricted to be negative in the PSM. This indicates an inconsistency
between the statistical models used in this case for modeling PFS and
OS, and may be an additional reason why STMs may be preferred in this
case.</p>
</div>
<div class="section level2">
<h2 id="visual-inspection-of-model-fits">Visual inspection of model fits<a class="anchor" aria-label="anchor" href="#visual-inspection-of-model-fits"></a>
</h2>
<p>Creating the four graphics of model fit is straightforward.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate graphs (can take time)</span></span>
<span><span class="va">ptdgraphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_survs.html">graph_survs</a></span><span class="op">(</span><span class="va">bosonc</span>, <span class="va">params</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating KM </span></span>
<span><span class="co">#&gt; Calculating fitted curves </span></span>
<span><span class="co">#&gt; Rearranging datasets </span></span>
<span><span class="co">#&gt; Drawing plots</span></span></code></pre></div>
<p>We can then compare state membership probabilities for the PF and PD
states.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for PF state</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pf</span> <span class="op">+</span> <span class="fu">scale_color_npg</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pf-1.png" width="700"></p>
<p>The PF curves fully overlap with each other in the observed period,
and appear to fit well visually to the observed PF data.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for PD state</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pd</span> <span class="op">+</span> <span class="fu">scale_color_npg</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pd-1.png" width="700"></p>
<p>There are big differences in the fit between the models to the PD
membership probability. The best visual fit comes from the PSM. Both
STMs estimate a higher probability of PD membership at later times than
was observed. The highest probabilities are from the STM-CF model.</p>
<p>Next, we can look at probabilities of being alive (i.e: membership in
either PF or PD state).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for OS</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">os</span> <span class="op">+</span> <span class="fu">scale_color_npg</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_os-1.png" width="700"></p>
<p>Again, all three models fit fairly well up to 15 weeks. The closest
visual fit to the OS curve is from the PSM. This is not surprising
because the PSM involves fitting the OS endpoint directly. Following
from the PD membership graphics, both STMs appear to over-estimate OS at
longer durations relative to the observed data. However, recall that
overall the PSM had the worse fit to the data according to likelihood,
AIC and BIC.</p>
<p>Finally we can look at probabilities of post-progression survival.
This is observed and fitted for the STMs not the the PSM. The STM-CR
estimate follows directly from the fitted PPS-CR survival curve. The
STM-CF estimate is derived based on the average, across patients, of
patients’ expected PPS-CF survival relative to their TTP timepoint.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Probabilities of PPS</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pps</span> <span class="op">+</span> <span class="fu">scale_color_npg</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 85 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pps-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Jackson C, Metcalfe P, Amdahl J, Warkentin MT, Sweeting M,
Kunzmann K. flexsurv: Flexible Parametric Survival and Multi-State
Models. Available at: <a href="https://cran.r-project.org/package=flexsurv" class="external-link uri">https://cran.r-project.org/package=flexsurv</a>.</p></li>
<li><p>Woods BS, Sideris E, Palmer S, Latimer N, Soares M. Partitioned
Survival and State Transition Models for Healthcare Decision Making in
Oncology: Where Are We Now? Value in Health 23(12):1613-21; 2020. <a href="https://doi.org/10.1016/j.jval.2020.08.2094" class="external-link">DOI:
10.1016/j.jval.2020.08.2094</a></p></li>
<li><p>Royston P and Parmar M. Flexible parametric proportional-hazards
and proportional-odds models for censored survival data, with
application to prognostic modelling and estimation of treatment effects.
Statistics in Medicine 21(1):2175-2197; 2002. <a href="https://doi.org/10.1002/sim.1203" class="external-link">DOI:
10.1002/sim.1203</a></p></li>
<li><p>Hanpu Z. Predictive Evaluation Metrics in Survival Analysis.
Vignette to the <em>SurvMetrics</em> R package. July 2021. Available
from: <a href="https://cran.r-project.org/package=SurvMetrics/vignettes/SurvMetrics-vignette.html" class="external-link uri">https://cran.r-project.org/package=SurvMetrics/vignettes/SurvMetrics-vignette.html</a></p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Dominic Muston, Merck &amp; Co., Inc.. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8. <br>Copyright © 2024 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
