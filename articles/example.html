<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example use of psm3mkv • psm3mkv</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Example use of psm3mkv">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">psm3mkv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/example.html">Example use of psm3mkv</a></li>
    <li><a class="dropdown-item" href="../articles/mortality-adjustments.html">Mortality adjustments</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Merck/psm3mkv/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Example use of psm3mkv</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/psm3mkv/blob/main/vignettes/example.Rmd" class="external-link"><code>vignettes/example.Rmd</code></a></small>
      <div class="d-none name"><code>example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette walks through evaluating the partitioned survival model
(PSM) and state transition model structures (either clock reset, STM-CR,
or clock forward types, STM-CF) to a dataset derived from the
<code>bosms3</code> dataset that comes with the flexsurv package <span class="citation">(Jackson 2016)</span>. A review of PSMs and STMs in
oncology cost-effectiveness models is provided by <span class="citation">Woods et al. (2020)</span>.</p>
<p>First we need to load the packages of interest. If you haven’t
installed psm3mkv yet, please see the <a href="https://github.com/Merck/psm3mkv?tab=readme-ov-file#installation" class="external-link">installation
instructions</a> to install it with all its dependencies. We will also
be using <span class="citation">Angelo Canty and B. D. Ripley
(2024)</span>, <span class="citation">Xiao (2024)</span> and <span class="citation">Wickham and Henry (2023)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://nanx.me/ggsci/" class="external-link">"ggsci"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://merck.github.io/psm3mkv/">"psm3mkv"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://purrr.tidyverse.org/" class="external-link">"purrr"</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="obtaining-a-suitable-dataset">Obtaining a suitable dataset<a class="anchor" aria-label="anchor" href="#obtaining-a-suitable-dataset"></a>
</h2>
<p>First we create a suitable patient-level dataset using
<code><a href="../reference/create_dummydata.html">create_dummydata()</a></code>. Here we load data derived from the
<code>bosms3</code> dataset with the flexsurv package <span class="citation">(Jackson 2016)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create and review the dummy dataset</span></span>
<span><span class="va">bosonc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_dummydata.html">create_dummydata</a></span><span class="op">(</span><span class="st">"flexbosms"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;    ptid pfs.durn pfs.flag os.durn os.flag ttp.durn ttp.flag</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1   18.7          1   42.9        1   18.7          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2   12.0          1   23.3        1   12.0          1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3    0.452        1    8.81       1    0.452        1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4    9.07         1   52.7        1    9.07         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5   47.7          0   47.7        0   47.7          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6    3.26         1   13.1        1    3.26         1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span><span class="co">#&gt;       ptid           pfs.durn          pfs.flag         os.durn      </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   : 0.1071   Min.   :0.0000   Min.   : 0.881  </span></span>
<span><span class="co">#&gt;  1st Qu.: 51.75   1st Qu.: 4.2381   1st Qu.:0.0000   1st Qu.: 7.893  </span></span>
<span><span class="co">#&gt;  Median :102.50   Median : 9.7262   Median :1.0000   Median :15.226  </span></span>
<span><span class="co">#&gt;  Mean   :102.50   Mean   :11.5630   Mean   :0.6471   Mean   :17.055  </span></span>
<span><span class="co">#&gt;  3rd Qu.:153.25   3rd Qu.:16.2321   3rd Qu.:1.0000   3rd Qu.:22.729  </span></span>
<span><span class="co">#&gt;  Max.   :204.00   Max.   :48.5357   Max.   :1.0000   Max.   :52.702  </span></span>
<span><span class="co">#&gt;     os.flag          ttp.durn          ttp.flag     </span></span>
<span><span class="co">#&gt;  Min.   :0.0000   Min.   : 0.1071   Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000   1st Qu.: 4.2381   1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :0.0000   Median : 9.7262   Median :1.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.4755   Mean   :11.5630   Mean   :0.5049  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000   3rd Qu.:16.2321   3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000   Max.   :48.5357   Max.   :1.0000</span></span></code></pre></div>
<p>The dataset contains TTP, PFS and OS data for 204 patients.</p>
</div>
<div class="section level2">
<h2 id="fit-survival-curves-to-the-relevant-endpoints">Fit survival curves to the relevant endpoints<a class="anchor" aria-label="anchor" href="#fit-survival-curves-to-the-relevant-endpoints"></a>
</h2>
<p>The three cost-effectiveness model structures we are considering rely
on modeling not only of PFS, TTP and OS, but additionally three other
endpoints:</p>
<ul>
<li>Pre-progression death (PPD).</li>
<li>Post progression survival as a function of time from baseline (known
as ‘clock forward’, PPS-CF).</li>
<li>Post-progression survival as a function of time from progression
(known as ‘clock reset’, PPS-CR).</li>
</ul>
<p>Once we have a suitable dataset, we will fit statistical models to
these six endpoints.</p>
<div class="section level3">
<h3 id="parametric-distributions">Parametric distributions<a class="anchor" aria-label="anchor" href="#parametric-distributions"></a>
</h3>
<p>Let us start by considering parametric distributions. This uses the
function <code>fit_ends_mods()</code>, so called because it cycles
through fitting endpoints and models. The original dataset contained
only three of these endpoints, the other three endpoints are calculated
within the function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a vector of distributions of interest (flexsurv notation)</span></span>
<span><span class="va">alldists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp"</span>, <span class="st">"weibullPH"</span>, <span class="st">"llogis"</span>, <span class="st">"lnorm"</span>, <span class="st">"gamma"</span>, <span class="st">"gompertz"</span>, <span class="st">"gengamma"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit all distributions to all endpoints (except gengamma to PPD and TTP)</span></span>
<span><span class="va">allfits_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_ends_mods_par.html">fit_ends_mods_par</a></span><span class="op">(</span></span>
<span>  <span class="va">bosonc</span>,</span>
<span>  cuttime <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  ppd.dist <span class="op">=</span> <span class="va">alldists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>  ttp.dist <span class="op">=</span> <span class="va">alldists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>  pfs.dist <span class="op">=</span> <span class="va">alldists</span>,</span>
<span>  os.dist <span class="op">=</span> <span class="va">alldists</span>,</span>
<span>  pps_cf.dist <span class="op">=</span> <span class="va">alldists</span>,</span>
<span>  pps_cr.dist <span class="op">=</span> <span class="va">alldists</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example 1 - PFS endpoint, distribution 2 (weibullPH)</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, dist = ..2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;        est     L95%    U95%    se    </span></span>
<span><span class="co">#&gt; shape  0.9313  0.8080  1.0733  0.0675</span></span>
<span><span class="co">#&gt; scale  0.0676  0.0453  0.1009  0.0138</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -512.0729, df = 2</span></span>
<span><span class="co">#&gt; AIC = 1028.146</span></span>
<span></span>
<span><span class="co"># Example 2 - Parameter values for PPS-CF and PPS-CR endpoints for distribution 3 (llogis)</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">res</span></span>
<span><span class="co">#&gt;             est     L95%     U95%        se</span></span>
<span><span class="co">#&gt; shape  1.625037 1.264658  2.08811 0.2078833</span></span>
<span><span class="co">#&gt; scale 12.184292 8.588947 17.28465 2.1737642</span></span>
<span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cr</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">res</span></span>
<span><span class="co">#&gt;             est     L95%      U95%        se</span></span>
<span><span class="co">#&gt; shape  1.602773 1.321696  1.943626 0.1576797</span></span>
<span><span class="co">#&gt; scale 11.031674 8.769443 13.877487 1.2917274</span></span></code></pre></div>
<p>We have fitted multiple parametric distributions to each endpoint. We
only need to retain the best-fitting distribution, which we select using
<code>find_bestfit_par()</code> on the basis of the distribution having
the lowest Akaike Information Criterion (AIC).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pick out best distribution according to min AIC</span></span>
<span><span class="va">fitpar.ppd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">ppd</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.ttp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">ttp</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pfs</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">os</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pps_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitpar.pps_cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cr</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the selection for PFS</span></span>
<span><span class="va">fitpar.pfs</span></span>
<span><span class="co">#&gt; $fit</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, dist = ..2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;       est      L95%     U95%     se     </span></span>
<span><span class="co">#&gt; rate  0.05596  0.04718  0.06637  0.00487</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -512.5726, df = 1</span></span>
<span><span class="co">#&gt; AIC = 1027.145</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 13</span></span></span>
<span><span class="co">#&gt;      id valid conv  posdef  npts dists     pars loglik   aic   bic    ic rankaic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 TRUE  TRUE  TRUE     204 exp          1  -<span style="color: #BB0000;">513.</span> <span style="text-decoration: underline;">1</span>027. <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>027.       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 TRUE  TRUE  TRUE     204 weibull…     2  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>028. <span style="text-decoration: underline;">1</span>035. <span style="text-decoration: underline;">1</span>028.       3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 TRUE  TRUE  TRUE     204 llogis       2  -<span style="color: #BB0000;">513.</span> <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>037. <span style="text-decoration: underline;">1</span>031.       6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 TRUE  TRUE  TRUE     204 lnorm        2  -<span style="color: #BB0000;">517.</span> <span style="text-decoration: underline;">1</span>038. <span style="text-decoration: underline;">1</span>044. <span style="text-decoration: underline;">1</span>038.       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 TRUE  TRUE  TRUE     204 gamma        2  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>028. <span style="text-decoration: underline;">1</span>035. <span style="text-decoration: underline;">1</span>028.       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 TRUE  TRUE  TRUE     204 gompertz     2  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>027. <span style="text-decoration: underline;">1</span>034. <span style="text-decoration: underline;">1</span>027.       2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>     7 TRUE  TRUE  TRUE     204 gengamma     3  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>040. <span style="text-decoration: underline;">1</span>030.       5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: rankbic &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="royston-parmar-splines-models">Royston-Parmar splines models<a class="anchor" aria-label="anchor" href="#royston-parmar-splines-models"></a>
</h3>
<p>An alternative approach to parametric modeling is the use of
Royston-Parmar splines <span class="citation">(Royston and Parmar
2002)</span>. We can follow a similar approach, again using flexsurv
<span class="citation">(Jackson 2016)</span> to identify the
best-fitting spline distributions. To the six endpoints, we fit 9 spline
models: 1, 2 or 3 (internal) knots with either odds, hazard or normal
scales. This uses <code><a href="../reference/fit_ends_mods_spl.html">fit_ends_mods_spl()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit 1-3 knot splines with all 3 scales (odds, hazard, normal) to each endpoint</span></span>
<span><span class="va">allfits_spl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_ends_mods_spl.html">fit_ends_mods_spl</a></span><span class="op">(</span><span class="va">bosonc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example - PFS endpoint - 1 knot, odds scale</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, k = ..2, scale = ..3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;         est        L95%       U95%       se       </span></span>
<span><span class="co">#&gt; gamma0  -2.848058  -3.298634  -2.397482   0.229890</span></span>
<span><span class="co">#&gt; gamma1   0.832337   0.449968   1.214706   0.195090</span></span>
<span><span class="co">#&gt; gamma2  -0.025453  -0.051358   0.000453   0.013217</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -511.7148, df = 3</span></span>
<span><span class="co">#&gt; AIC = 1029.43</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">aux</span><span class="op">$</span><span class="va">scale</span> <span class="co"># Scale</span></span>
<span><span class="co">#&gt; [1] "odds"</span></span>
<span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">aux</span><span class="op">$</span><span class="va">knots</span> <span class="co"># Knot locations (log time)</span></span>
<span><span class="co">#&gt;                 50%           </span></span>
<span><span class="co">#&gt; -2.233592  2.008522  3.882300</span></span></code></pre></div>
<p>We have fitted multiple splines to each endpoint. We only need to
retain the best-fitting distribution, which we select on the basis of
the distribution having the lowest Akaike Information Criterion (AIC).
We use <code><a href="../reference/find_bestfit.html">find_bestfit()</a></code> for this.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pick out best distribution according to min AIC</span></span>
<span><span class="va">fitspl.ppd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">ppd</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.ttp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">ttp</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pfs</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">os</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pps_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cf</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span><span class="va">fitspl.pps_cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_bestfit.html">find_bestfit</a></span><span class="op">(</span><span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cr</span>, <span class="st">"aic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the selection for PFS</span></span>
<span><span class="va">fitspl.pfs</span></span>
<span><span class="co">#&gt; $fit</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; .f(formula = ..1, k = ..2, scale = ..3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: </span></span>
<span><span class="co">#&gt;         est       L95%      U95%      se      </span></span>
<span><span class="co">#&gt; gamma0  -1.62401  -1.84681  -1.40122   0.11367</span></span>
<span><span class="co">#&gt; gamma1   0.37082   0.20155   0.54008   0.08636</span></span>
<span><span class="co">#&gt; gamma2  -0.02243  -0.03539  -0.00947   0.00661</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N = 204,  Events: 132,  Censored: 72</span></span>
<span><span class="co">#&gt; Total time at risk: 2358.845</span></span>
<span><span class="co">#&gt; Log-likelihood = -511.4637, df = 3</span></span>
<span><span class="co">#&gt; AIC = 1028.927</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 14</span></span></span>
<span><span class="co">#&gt;      id valid conv  posdef  npts scales nknots  pars loglik   aic   bic    ic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 TRUE  TRUE  TRUE     204 hazard      1     3  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>040. <span style="text-decoration: underline;">1</span>030.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 TRUE  TRUE  TRUE     204 odds        1     3  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>029. <span style="text-decoration: underline;">1</span>039. <span style="text-decoration: underline;">1</span>029.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 TRUE  TRUE  TRUE     204 normal      1     3  -<span style="color: #BB0000;">511.</span> <span style="text-decoration: underline;">1</span>029. <span style="text-decoration: underline;">1</span>039. <span style="text-decoration: underline;">1</span>029.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 TRUE  TRUE  TRUE     204 hazard      2     4  -<span style="color: #BB0000;">512.</span> <span style="text-decoration: underline;">1</span>032. <span style="text-decoration: underline;">1</span>045. <span style="text-decoration: underline;">1</span>032.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 TRUE  TRUE  TRUE     204 odds        2     4  -<span style="color: #BB0000;">511.</span> <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>044. <span style="text-decoration: underline;">1</span>031.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 TRUE  TRUE  TRUE     204 normal      2     4  -<span style="color: #BB0000;">511.</span> <span style="text-decoration: underline;">1</span>031. <span style="text-decoration: underline;">1</span>044. <span style="text-decoration: underline;">1</span>031.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>     7 TRUE  TRUE  TRUE     204 hazard      3     5  -<span style="color: #BB0000;">510.</span> <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>046. <span style="text-decoration: underline;">1</span>030.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>     8 TRUE  TRUE  TRUE     204 odds        3     5  -<span style="color: #BB0000;">510.</span> <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>047. <span style="text-decoration: underline;">1</span>030.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span>     9 TRUE  TRUE  TRUE     204 normal      3     5  -<span style="color: #BB0000;">510.</span> <span style="text-decoration: underline;">1</span>030. <span style="text-decoration: underline;">1</span>046. <span style="text-decoration: underline;">1</span>030.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: rankaic &lt;dbl&gt;, rankbic &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combine-the-best-fits">Combine the best fits<a class="anchor" aria-label="anchor" href="#combine-the-best-fits"></a>
</h3>
<p>Finally, we select our preferred curves for each endpoint. These may
or may not be those selected as the minimum AIC and may be parametric
fits or spline fits. This list is deliberately programmed manually - and
carefully. Our example does not use the best fits in each case but
merely illustrates the options available to the modeler.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bring together our preferred fits for each endpoint in a list</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ppd <span class="op">=</span> <span class="va">fitpar.ppd</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>  ttp <span class="op">=</span> <span class="va">fitpar.ttp</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>  pfs <span class="op">=</span> <span class="va">fitspl.pfs</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>  os <span class="op">=</span> <span class="va">fitspl.os</span><span class="op">$</span><span class="va">fit</span>,</span>
<span>  pps_cf <span class="op">=</span> <span class="va">allfits_par</span><span class="op">$</span><span class="va">pps_cf</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span>,</span>
<span>  pps_cr <span class="op">=</span> <span class="va">allfits_spl</span><span class="op">$</span><span class="va">pps_cr</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let us count how many parameters we are using in each model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pull out number of parameters used for each endpoint</span></span>
<span><span class="va">count_npar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_vec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">~</span> <span class="va">params</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">npars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PSM uses PFS (3) and OS (4) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="co"># STM_CF uses PPD (1), TTP (2) and PPS_CF (5) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="co"># STM_CR uses PPD (1), TTP (2) and PPS_CR (6) endpoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count_npar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-likelihood-values-for-the-three-model-structures">Comparing likelihood values for the three model structures<a class="anchor" aria-label="anchor" href="#comparing-likelihood-values-for-the-three-model-structures"></a>
</h2>
<p>Given the selected survival modeling of each endpoint, we can now
calculate and compare the (log-)likelihood of each of the three model
structures. We can also check this output to ensure that the number of
parameters used in each model structure matches what we derived
earlier.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_likes.html">calc_likes</a></span><span class="op">(</span><span class="va">bosonc</span>, <span class="va">params</span><span class="op">)</span></span>
<span><span class="va">ll_all</span></span>
<span><span class="co">#&gt; $all</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 12</span></span></span>
<span><span class="co">#&gt;   methname     npar npts_1 npts_2 npts_3 npts_4 npts_tot  ll_1  ll_2  ll_3  ll_4</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> psm_simple      7     72     29     35     68      204 -<span style="color: #BB0000;">64.8</span> -<span style="color: #BB0000;">152.</span> -<span style="color: #BB0000;">151.</span>   <span style="color: #BB0000;">NA</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> psm_complex     8     72     29     35     68      204 -<span style="color: #BB0000;">64.8</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">149.</span> -<span style="color: #BB0000;">471.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> stm_cf          6     72     29     35     68      204 -<span style="color: #BB0000;">64.7</span> -<span style="color: #BB0000;">147.</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">474.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> stm_cr          7     72     29     35     68      204 -<span style="color: #BB0000;">64.7</span> -<span style="color: #BB0000;">147.</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">474.</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ll_tot &lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $valid</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 12</span></span></span>
<span><span class="co">#&gt;   methname     npar npts_1 npts_2 npts_3 npts_4 npts_tot  ll_1  ll_2  ll_3  ll_4</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> psm_simple      7     72     29     35     67      203 -<span style="color: #BB0000;">64.8</span> -<span style="color: #BB0000;">152.</span> -<span style="color: #BB0000;">151.</span> -<span style="color: #BB0000;">469.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> psm_complex     8     72     29     35     67      203 -<span style="color: #BB0000;">64.8</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">149.</span> -<span style="color: #BB0000;">466.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> stm_cf          6     72     29     35     67      203 -<span style="color: #BB0000;">64.7</span> -<span style="color: #BB0000;">147.</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">468.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> stm_cr          7     72     29     35     67      203 -<span style="color: #BB0000;">64.7</span> -<span style="color: #BB0000;">147.</span> -<span style="color: #BB0000;">148.</span> -<span style="color: #BB0000;">468.</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ll_tot &lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sum</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 8</span></span></span>
<span><span class="co">#&gt;   methname     npts  npar    ll   aic   bic rank_aic rank_bic</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> psm_simple    203     7 -<span style="color: #BB0000;">836.</span> <span style="text-decoration: underline;">1</span>685. <span style="text-decoration: underline;">1</span>709.        4        4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> psm_complex   203     8 -<span style="color: #BB0000;">828.</span> <span style="text-decoration: underline;">1</span>672. <span style="text-decoration: underline;">1</span>698.        3        3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> stm_cf        203     6 -<span style="color: #BB0000;">828.</span> <span style="text-decoration: underline;">1</span>667. <span style="text-decoration: underline;">1</span>687.        2        1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> stm_cr        203     7 -<span style="color: #BB0000;">827.</span> <span style="text-decoration: underline;">1</span>667. <span style="text-decoration: underline;">1</span>690.        1        2</span></span></code></pre></div>
<p>In this case, the model structures could be fitted to 203 of the 204
patients. Among the 203 patients where models could be fitted, the
STM-CR model has the greatest likelihood (best fitting) and also the
lowest AIC (most efficient). (Since these are not nested models, and
statistical distributions under the null hypothesis are not easily
formed, we cannot readily derive a p-value for the statistical
significance of this difference.)</p>
</div>
<div class="section level2">
<h2 id="comparing-the-implied-restricted-mean-durations">Comparing the implied (restricted) mean durations<a class="anchor" aria-label="anchor" href="#comparing-the-implied-restricted-mean-durations"></a>
</h2>
<p>In order to understand the degree of structural uncertainty
(sensitivity to the choice of model structure), we calculate the
(restricted) mean durations in progression-free (PF) and progressed
disease (PD) states by model type. To do this, we call the
<code><a href="../reference/calc_allrmds.html">calc_allrmds()</a></code> function with the dataset and statistical
distributions we wish to consider for each endpoint. The function also
allows specification of the patient subset to use (<code>inclset</code>,
important for bootstrapping later) and the time horizon. The units for
the time horizon are 52.18 times shorter than the units for the output
because - the time horizon can be considered to be in units of years,
whereas the output is in units of weeks.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call the RMD functions</span></span>
<span><span class="va">rmd_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_allrmds.html">calc_allrmds</a></span><span class="op">(</span><span class="va">bosonc</span>, dpam <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then review the mean duration in PF, PD and total alive (OS)</span></span>
<span><span class="va">rmd_all</span><span class="op">$</span><span class="va">results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;      pf    pd    os model </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  22.0  5.41  27.4 PSM   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  20.0 10.4   30.4 STM-CF</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  20.0 13.3   33.3 STM-CR</span></span></code></pre></div>
<p>The two STMs estimate a duration in the PF state slightly longer than
the PSM. The PSM also estimates the least time in the PD state and alive
overall than the other models. The STM-CF provides the longest estimate
of time in the PD state and overall.</p>
<p>The above output can be bootstrapped to generate standard errors.
Here we use just 10 boostrap samples (<code>R=10</code>) just to
illustrate the process. In practice, we would want to use far more than
10 samples.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bootstrap to calculate SE over 10 bootstrap samples</span></span>
<span><span class="fu">boot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">bosonc</span>,</span>
<span>  statistic <span class="op">=</span> <span class="va">calc_allrmds</span>,</span>
<span>  R <span class="op">=</span> <span class="fl">10</span>, <span class="co"># Number of samples</span></span>
<span>  cuttime <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  Ty <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  dpam <span class="op">=</span> <span class="va">params</span>,</span>
<span>  boot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; boot::boot(data = bosonc, statistic = calc_allrmds, R = 10, cuttime = 0, </span></span>
<span><span class="co">#&gt;     Ty = 10, dpam = params, boot = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bootstrap Statistics :</span></span>
<span><span class="co">#&gt;     original     bias    std. error</span></span>
<span><span class="co">#&gt; t1* 22.02965  1.6639145    3.764406</span></span>
<span><span class="co">#&gt; t2* 19.95750  1.0415112    3.079635</span></span>
<span><span class="co">#&gt; t3* 19.95750  1.0415112    3.079635</span></span>
<span><span class="co">#&gt; t4*  5.41287 -0.4906403    3.728078</span></span>
<span><span class="co">#&gt; t5* 10.41262  0.7997145    2.232518</span></span>
<span><span class="co">#&gt; t6* 13.32346  1.4157501    3.260064</span></span>
<span><span class="co">#&gt; t7* 27.44252  1.1732742    2.421223</span></span>
<span><span class="co">#&gt; t8* 30.37012  1.8412257    2.909540</span></span>
<span><span class="co">#&gt; t9* 33.28096  2.4572614    3.736715</span></span></code></pre></div>
<p>Note that the percentiles information reported indicates that in a
small number of samples, the restricted mean duration in PD was
restricted to be negative in the PSM. This indicates an inconsistency
between the statistical models used in this case for modeling PFS and
OS, and may be an additional reason why STMs may be preferred in this
case.</p>
</div>
<div class="section level2">
<h2 id="visual-inspection-of-model-fits">Visual inspection of model fits<a class="anchor" aria-label="anchor" href="#visual-inspection-of-model-fits"></a>
</h2>
<p>Creating the four graphics of model fit is straightforward.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate graphs (can take time)</span></span>
<span><span class="va">ptdgraphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_survs.html">graph_survs</a></span><span class="op">(</span><span class="va">bosonc</span>, <span class="va">params</span><span class="op">)</span></span></code></pre></div>
<p>We can then compare state membership probabilities for the PF and PD
states.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for PF state</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pf</span> <span class="op">+</span> <span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pf-1.png" width="700"></p>
<p>The PF curves fully overlap with each other in the observed period,
and appear to fit well visually to the observed PF data.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for PD state</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pd</span> <span class="op">+</span> <span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pd-1.png" width="700"></p>
<p>There are big differences in the fit between the models to the PD
membership probability. The best visual fit comes from the PSM. Both
STMs estimate a higher probability of PD membership at later times than
was observed. The highest probabilities are from the STM-CF model.</p>
<p>Next, we can look at probabilities of being alive (i.e: membership in
either PF or PD state).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># State membership probabilities for OS</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">os</span> <span class="op">+</span> <span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_os-1.png" width="700"></p>
<p>Again, all three models fit fairly well up to 15 weeks. The closest
visual fit to the OS curve is from the PSM. This is not surprising
because the PSM involves fitting the OS endpoint directly. Following
from the PD membership graphics, both STMs appear to over-estimate OS at
longer durations relative to the observed data. However, recall that
overall the PSM had the worse fit to the data according to likelihood,
AIC and BIC.</p>
<p>Finally we can look at probabilities of post-progression survival.
This is observed and fitted for the STMs not the the PSM. The STM-CR
estimate follows directly from the fitted PPS-CR survival curve. The
STM-CF estimate is derived based on the average, across patients, of
patients’ expected PPS-CF survival relative to their TTP timepoint.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Probabilities of PPS</span></span>
<span><span class="va">ptdgraphs</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pps</span> <span class="op">+</span> <span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 393 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="example_files/figure-html/graph_pps-1.png" width="700"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-pack_boot" class="csl-entry">
Angelo Canty, and B. D. Ripley. 2024. <em>Boot: Bootstrap <span>R</span>
(<span>S-Plus</span>) Functions</em>.
</div>
<div id="ref-jackson2016flexsurv" class="csl-entry">
Jackson, Christopher. 2016. <span>“<span class="nocase">flexsurv</span>:
A Platform for Parametric Survival Modeling in <span>R</span>.”</span>
<em>Journal of Statistical Software</em> 70 (8): 1–33.
</div>
<div id="ref-royston2002flexible" class="csl-entry">
Royston, Patrick, and Mahesh KB Parmar. 2002. <span>“Flexible Parametric
Proportional-Hazards and Proportional-Odds Models for Censored Survival
Data, with Application to Prognostic Modelling and Estimation of
Treatment Effects.”</span> <em>Statistics in Medicine</em> 21 (15):
2175–97.
</div>
<div id="ref-pack_purrr" class="csl-entry">
Wickham, Hadley, and Lionel Henry. 2023. <em><span class="nocase">purrr</span>: Functional Programming Tools</em>. <a href="https://CRAN.R-project.org/package=purrr" class="external-link">https://CRAN.R-project.org/package=purrr</a>.
</div>
<div id="ref-woods2020partitioned" class="csl-entry">
Woods, Beth S, Eleftherios Sideris, Stephen Palmer, Nick Latimer, and
Marta Soares. 2020. <span>“Partitioned Survival and State Transition
Models for Healthcare Decision Making in Oncology: Where Are We
Now?”</span> <em>Value in Health</em> 23 (12): 1613–21.
</div>
<div id="ref-pack_ggsci" class="csl-entry">
Xiao, Nan. 2024. <em><span class="nocase">ggsci</span>: Scientific
Journal and Sci-Fi Themed Color Palettes for ’<span class="nocase">ggplot2</span>’</em>. <a href="https://CRAN.R-project.org/package=ggsci" class="external-link">https://CRAN.R-project.org/package=ggsci</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dominic Muston, Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1. <br>Copyright © 2024 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p><span></span></p>
</div>

    </footer>
</div>





  </body>
</html>
